<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Sistema de Alertas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #1f2937;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #6b7280;
        }

        .status-panel {
            background: #f3f4f6;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .logout-button {
            background: #ef4444;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-button:hover {
            background: #b91c1c;
        }

        .alert-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alert-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .alert-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .alert-card.selected {
            border: 3px solid #667eea;
            transform: scale(1.05);
        }

        .alert-card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .alert-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .alert-card-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .form-section {
            display: none;
            /* Esconde o formul√°rio para a nova interface de clique r√°pido */
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideInRight 0.3s ease-out;
            z-index: 1000;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 5px solid #22c55e;
        }

        .notification.info {
            border-left: 5px solid #3b82f6;
        }

        .notification.error {
            border-left: 5px solid #dc2626;
        }

        .history {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .history h2 {
            color: #1f2937;
            margin-bottom: 20px;
        }

        .history-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f9fafb;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-item-type {
            font-weight: bold;
            color: #1f2937;
        }

        .history-item-time {
            color: #6b7280;
            font-size: 14px;
        }

        .history-item-message {
            color: #4b5563;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üõ°Ô∏è</span>
                Painel Administrativo - Sistema de Alertas
            </h1>
            <p>Clique em um dos tipos de alerta abaixo para envi√°-lo imediatamente para todas as esta√ß√µes.</p>

            <div class="status-panel">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>Sistema Online</span>
                </div>
                <div class="status-item">
                    <span id="clientCount">Carregando...</span>
                </div>
                <a href="/logout" class="logout-button">Sair</a>
            </div>
        </div>

        <div class="alert-types">
            <div class="alert-card" data-type="fire">
                <div class="alert-card-icon">üî•</div>
                <div class="alert-card-title">Inc√™ndio</div>
                <div class="alert-card-desc">Alerta de inc√™ndio detectado</div>
            </div>

            <div class="alert-card" data-type="attack">
                <div class="alert-card-icon">‚ö†Ô∏è</div>
                <div class="alert-card-title">Ataque</div>
                <div class="alert-card-desc">Amea√ßa de ataque iminente</div>
            </div>

            <div class="alert-card" data-type="emergency">
                <div class="alert-card-icon">üö®</div>
                <div class="alert-card-title">Emerg√™ncia</div>
                <div class="alert-card-desc">Emerg√™ncia geral</div>
            </div>

            <div class="alert-card" data-type="evacuation">
                <div class="alert-card-icon">üö™</div>
                <div class="alert-card-title">Evacua√ß√£o</div>
                <div class="alert-card-desc">Ordem de evacua√ß√£o imediata</div>
            </div>
        </div>

        <div class="form-section">
        </div>

        <div class="history">
            <h2>üìã Hist√≥rico de Alertas</h2>
            <div id="historyList">
                <p style="color: #9ca3af; text-align: center;">Nenhum alerta enviado ainda</p>
            </div>
        </div>

        <footer>
            <p>&copy;2025 | Desenvolvido por <a href="https://devgui.com.br" target="_blank">Guilherme Araujo</a></p>
        </footer>

    </div>

    <div class="notification" id="notification">
        <div id="notificationMessage"></div>
    </div>

    <script>
        const alertCards = document.querySelectorAll('.alert-card');
        const historyList = document.getElementById('historyList');
        const clientCount = document.getElementById('clientCount');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');

        // =============================================================
        //              NOVO: MENSAGENS E T√çTULOS FIXOS
        // =============================================================
        const predefinedAlerts = {
            fire: {
                title: 'ALERTA DE INC√äNDIO',
                message: 'EVACUA√á√ÉO IMEDIATA. Dirija-se √† sa√≠da de emerg√™ncia mais pr√≥xima. N√ÉO utilize os elevadores.'
            },
            attack: {
                title: 'ALERTA DE ATAQUE',
                message: 'AMEA√áA IMINENTE. Mantenha-se em local seguro, silencie seu celular e aguarde instru√ß√µes das autoridades.'
            },
            emergency: {
                title: 'EMERG√äNCIA GERAL',
                message: 'ATEN√á√ÉO. Uma situa√ß√£o de emerg√™ncia foi declarada. Por favor, mantenha a calma e aguarde novas informa√ß√µes.'
            },
            evacuation: {
                title: 'ORDEM DE EVACUA√á√ÉO',
                message: 'EVACUA√á√ÉO GERAL. Dirija-se ao ponto de encontro com calma e em seguran√ßa.'
            }
        };

        // =============================================================
        //           NOVO: L√ìGICA DE CLIQUE DIRETO NOS CARDS
        // =============================================================
        alertCards.forEach(card => {
            card.addEventListener('click', () => {
                const type = card.dataset.type;
                const alertData = predefinedAlerts[type];

                // Passo de confirma√ß√£o para evitar cliques acidentais
                const confirmation = confirm(
                    `‚ö†Ô∏è CONFIRMA√á√ÉO DE ENVIO IMEDIATO\n\n` +
                    `Tipo de Alerta: ${alertData.title}\n\n` +
                    `Deseja enviar este alerta para TODAS as esta√ß√µes conectadas?`
                );

                if (confirmation) {
                    sendAlert(type, alertData.title, alertData.message);
                }
            });
        });

        // Fun√ß√£o de envio adaptada para ser reutiliz√°vel
        async function sendAlert(type, title, message) {
            // Desabilita todos os cards para evitar m√∫ltiplos envios
            alertCards.forEach(c => c.style.pointerEvents = 'none');

            showNotification('üì° Enviando alerta...', 'info'); // Notifica√ß√£o de envio

            try {
                const response = await fetch('/api/alert', { // Removido IP fixo para funcionar em qualquer ambiente
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: type,
                        title: title,
                        message: message,
                        priority: 'critical'
                    })
                });

                if (!response.ok) {
                    // Se a sess√£o expirou, o servidor redireciona. O navegador segue o redirecionamento.
                    if (response.status === 401 || response.redirected) {
                        showNotification('‚ùå Sess√£o expirada. Redirecionando para a p√°gina de login...', 'error');
                        setTimeout(() => window.location.href = '/login', 2000);
                        return;
                    }
                    throw new Error(`Erro na resposta do servidor: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showNotification(`‚úÖ Alerta enviado com sucesso para ${result.clientsNotified} esta√ß√£o(√µes)!`, 'success');
                    addToHistory(result.alert);
                } else {
                    throw new Error(result.error || 'Erro ao enviar alerta');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('‚ùå Erro ao enviar alerta. Verifique a conex√£o com o servidor.', 'error');
            } finally {
                // Reabilita os cards ap√≥s o envio (com sucesso ou falha)
                alertCards.forEach(c => c.style.pointerEvents = 'auto');
            }
        }

        // Fun√ß√£o para mostrar notifica√ß√£o (adicionado tipo 'info')
        function showNotification(message, type) {
            notificationMessage.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            // Esconde a notifica√ß√£o ap√≥s 5 segundos, a menos que seja um erro
            if (type !== 'error') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        }

        // Adicionar ao hist√≥rico (usando o t√≠tulo do alerta recebido do servidor)
        function addToHistory(alert) {
            if (historyList.querySelector('p')) {
                historyList.innerHTML = '';
            }
            const item = document.createElement('div');
            item.className = 'history-item';
            const time = new Date(alert.timestamp);
            const timeStr = time.toLocaleString('pt-BR');
            item.innerHTML = `
                <div class="history-item-header">
                  <span class="history-item-type">${predefinedAlerts[alert.type].title}</span>
                  <span class="history-item-time">${timeStr}</span>
                </div>
                <div class="history-item-message">${alert.message}</div>
            `;
            historyList.insertBefore(item, historyList.firstChild);
        }

        // Atualizar contagem de clientes (fun√ß√£o permanece a mesma)
        async function updateClientCount() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    if (response.status === 401 || response.redirected) {
                        clientCount.textContent = 'Sess√£o expirada';
                        return;
                    }
                    throw new Error('Erro ao buscar status');
                }
                const data = await response.json();
                clientCount.textContent = `${data.connectedClients} esta√ß√£o(√µes) conectada(s)`;
            } catch (error) {
                clientCount.textContent = 'Erro de conex√£o';
            }
        }

        updateClientCount();
        setInterval(updateClientCount, 5000);
    </script>
</body>

</html>